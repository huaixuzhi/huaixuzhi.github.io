<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>TCP单机连接数限制 | 纸上得来</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">TCP单机连接数限制</h1><a id="logo" href="/.">纸上得来</a><p class="description">酒盏酌来须满满，花枝看即落纷纷。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">TCP单机连接数限制</h1><div class="post-meta">Jan 31, 2018<span> | </span><span class="category"><a href="/categories/网络/">网络</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP连接建立和释放流程："><span class="toc-number">1.</span> <span class="toc-text">TCP连接建立和释放流程：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP短连接"><span class="toc-number">2.</span> <span class="toc-text">TCP短连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP长连接"><span class="toc-number">3.</span> <span class="toc-text">TCP长连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP长连接keepalive机制"><span class="toc-number">4.</span> <span class="toc-text">TCP长连接keepalive机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP连接数的限制"><span class="toc-number">5.</span> <span class="toc-text">TCP连接数的限制</span></a></li></ol></div></div><div class="post-content"><h3 id="TCP连接建立和释放流程："><a href="#TCP连接建立和释放流程：" class="headerlink" title="TCP连接建立和释放流程："></a>TCP连接建立和释放流程：</h3><img src="/2018/01/31/tcp-limit/tcp.png">
<h3 id="TCP短连接"><a href="#TCP短连接" class="headerlink" title="TCP短连接"></a>TCP短连接</h3><p>　　在建立连接后，一般只会在Client和Server之间传递一次读写操作，然后链接关闭。<br>　　短连接的优点是：管理起来比较简单，存在的连接都是有用的连接，不需要额外的控制手段</p>
<h3 id="TCP长连接"><a href="#TCP长连接" class="headerlink" title="TCP长连接"></a>TCP长连接</h3><p>　　在建立连接，Client与Server完成一次读写后，它们之间的连接不会主动关闭，后续的读写操作会继续使用这个连接。</p>
<h3 id="TCP长连接keepalive机制"><a href="#TCP长连接keepalive机制" class="headerlink" title="TCP长连接keepalive机制"></a>TCP长连接keepalive机制</h3><p>　　默认的Keepalive超时需要2小时，探测次数为5次。开启Keepalive功能需要消耗额外的宽带和流量，尽管这微不足道，但在按流量计费的环境下增加了费用，另一方面，Keepalive设置不合理时可能会因为短暂的网络波动而断开健康的TCP连接。<br>　　<b>keepalive工作原理：</b><br>　　若在一个给定连接上，两小时之内无任何活动，服务器便向客户端发送一个探测段。</p>
<ul>
<li>客户端主机依旧活跃（up）运行，并且从服务器可到达。从客户端TCP的正常响应，服务器知道对方仍然活跃。服务器的TCP为接下来的两小时复位存活定时器，如果在这两个小时到期之前，连接上发生应用程序的通信，则定时器重新为往下的两小时复位，并且接着交换数据。</li>
<li>客户端已经崩溃，或者已经关闭（down），或者正在重启过程中。在这两种情况下，它的TCP都不会响应。服务器没有收到对其发出探测的响应，并且在75秒之后超时。服务器将总共发送10个这样的探测，每个探测75秒。如果没有收到一个响应，它就认为客户端主机已经关闭并终止连接。</li>
<li>客户端曾经崩溃，但已经重启。这种情况下，服务器将会收到对其存活探测的响应，但该响应是一个复位，从而引起服务器对连接的终止。</li>
<li>客户端主机活跃运行，但从服务器不可到达。这与状态2类似，因为TCP无法区别它们两个。它所能表明的仅是未收到对其探测的回复。</li>
</ul>
<p>　　服务器不必担心客户端主机被关闭然后重启的情况（这里指的是操作员执行的正常关闭，而不是主机的崩溃）。当系统被操作员关闭时，所有的应用程序进程（也就是客户端进程）都将被终止，客户端TCP会在连接上发送一个FIN。收到这个FIN后，服务器TCP向服务器进程报告一个文件结束，以允许服务器检测这种状态。<br>　　<font color="red">在长连接的应用场景下，client端一般不会主动关闭它们之间的连接，Client与server之间的连接如果一直不关闭的话，会存在一个问题，随着客户端连接越来越多，server早晚有扛不住的时候，这时候server端需要采取一些策略，如关闭一些长时间没有读写事件发生的连接，这样可以避免一些恶意连接导致server端服务受损；如果条件再允许就可以以客户端机器为颗粒度，限制每个客户端的最大长连接数，这样可以完全避免某个蛋疼的客户端连累后端服务</font></p>
<h3 id="TCP连接数的限制"><a href="#TCP连接数的限制" class="headerlink" title="TCP连接数的限制"></a>TCP连接数的限制</h3><p>　　TCP连接数主要受到三个方面的限制：文件描述符、TCP连接本身的数量、系统内存。</p>
<ul>
<li>每个TCP连接对应一个socket对象，每个socket对象本身占用一个文件描述符；</li>
<li>TCP四元组（源IP地址，源端口，目标IP地址，目标端口）标识一个TCP连接，对于两个TCP连接，四个参数里面必定有一个不同。对于服务器来说，一般来说，IP和本地端口固定，可以接受的连接数=2^32*65535；对于客户端来说，一般本地IP，远端IP，远端端口号都是固定的，因此可以支持的长连接数最多只有65535，所以，作为客户端的服务器比较容易出现端口耗尽的问题。<br><b>Linux系统对端口的限制，如下：</b><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dcgcy-test50 <span class="keyword">workspace</span>]# cat /<span class="keyword">proc</span>/sys/net/ipv4/ip_local_port_range</span><br><span class="line"><span class="number">1024</span>    <span class="number">65000</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>　　这两个值分别代表最小值和最大值，小于1024的端口号一般是预留给系统使用的，这不是强制的，你一定要把最小值改成小于1024也是可以的。</p>
<ul>
<li>关于系统内存限制，主要包含两个方面，一个是TCP元数据大小：包含sock、inode、file等结构；二是TCP缓存占用空间，又包含系统缓存和用户缓存，其中系统缓存是系统调用read/write使用的缓存，用户缓存是我们代码中设计的缓存区。<br>　　高人测试：写两个程序，服务端只接收连接，客户端只发起连接，不读写数据，客户端和服务端分别部署在两个虚拟机上，当建立50w个连接时，服务端消耗2g内存，大概每个socket占用4kb，这个4kb是内核申请的空间，并不增加用户进程的内存。</li>
</ul>
<p><b>附：TCP/IP的四元组、五元组、七元组</b><br>四元组是：<br>　　源IP地址、目的IP地址、源端口、目的端口<br>五元组是:<br>　　源IP地址、目的IP地址、协议号、源端口、目的端口<br>七元组是:<br>　　源IP地址、目的IP地址、协议号、源端口、目的端口，服务类型以及接口索引</p>
<p>参考网址：<br><a href="http://th7.cn/system/lin/201709/228306.shtml" target="_blank" rel="noopener">http://th7.cn/system/lin/201709/228306.shtml</a></p>
</div><script type="text/javascript" src="/js/share.js?v=1.0.0" async></script><a data-url="http://huaixuzhi.github.io/2018/01/31/tcp-limit/" data-id="cjf7wbr78001x0jw2f77zgi0u" class="article-share-link">分享到</a><div class="tags"><a href="/tags/基础知识/">基础知识</a><a href="/tags/架构/">架构</a></div><div class="post-nav"><a href="/2018/03/13/go-underline-description/" class="pre">GO语言下划线的作用</a><a href="/2018/01/31/fd-limit/" class="next">Linux打开文件句柄限制</a></div><div id="uyan_frame"><script src="http://v2.uyan.cc/code/uyan.js?uid='2128901## Your uyan_id. e.g. 1234567'"></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://huaixuzhi.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Flask/">Flask</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/GO语言/">GO语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂谈/">杂谈</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/流媒体/">流媒体</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/测试/">测试</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/测试/" style="font-size: 15px;">测试</a> <a href="/tags/WEB开发/" style="font-size: 15px;">WEB开发</a> <a href="/tags/基础知识/" style="font-size: 15px;">基础知识</a> <a href="/tags/面试/" style="font-size: 15px;">面试</a> <a href="/tags/架构设计/" style="font-size: 15px;">架构设计</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a> <a href="/tags/ruby/" style="font-size: 15px;">ruby</a> <a href="/tags/流媒体/" style="font-size: 15px;">流媒体</a> <a href="/tags/音视频/" style="font-size: 15px;">音视频</a> <a href="/tags/C语言/" style="font-size: 15px;">C语言</a> <a href="/tags/GO语言/" style="font-size: 15px;">GO语言</a> <a href="/tags/代码优化/" style="font-size: 15px;">代码优化</a> <a href="/tags/Shell/" style="font-size: 15px;">Shell</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/26/go-func-method/">GO语言函数方法method</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/go-xml-to-json/">GO XML转JSON</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/go-struct-tag/">GO语言struct成员变量标签tag</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/13/go-underline-description/">GO语言下划线的作用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/31/tcp-limit/">TCP单机连接数限制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/31/fd-limit/">Linux打开文件句柄限制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/31/my-assert/">设计并使用断言</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/25/streaming-architecture/">直播平台架构案例</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/24/network-basic-01/">阻塞非阻塞与同步异步</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/18/gdb-manual/">GDB常用命令</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://coolshell.cn/" title="CoolShell" target="_blank">CoolShell</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">纸上得来.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/huaixuzhi"> huaixz.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>